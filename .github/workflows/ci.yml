name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add LLVM apt repo and install clang-format 21
      run: |
        set -euo pipefail
        wget -qO - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        CODENAME=$(lsb_release -cs)
        sudo bash -c "echo \"deb http://apt.llvm.org/${CODENAME}/ llvm-toolchain-${CODENAME}-21 main\" > /etc/apt/sources.list.d/llvm-21.list"
        sudo apt-get update
        sudo apt-get install -y clang-format-21
        echo "clang-format version: $(clang-format-21 --version)"

    - name: Check code formatting
      run: ./tools/check-format.sh

  include-order-check:
    name: Include Order Check
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check include order
      run: ./tools/check-include-order.sh

  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add LLVM apt repo and install tooling
      run: |
        set -euo pipefail
        wget -qO - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        CODENAME=$(lsb_release -cs)
        sudo bash -c "echo \"deb http://apt.llvm.org/${CODENAME}/ llvm-toolchain-${CODENAME}-21 main\" > /etc/apt/sources.list.d/llvm-21.list"
        sudo apt-get update
        sudo apt-get install -y clang-21 clang-tidy-21 lld-21 ninja-build cmake \
          libxkbcommon-dev qt6-base-dev qt6-base-dev-tools qt6-tools-dev qt6-svg-dev
        echo "clang-tidy version: $(clang-tidy-21 --version | head -n1)"

    - name: Configure and run clang-tidy
      run: |
        ./tools/configure.sh debug
        ./tools/clang-tidy.sh

  build-and-test:
    name: Build and Test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        build-type: [debug, release]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add LLVM apt repo and install dependencies
      run: |
        set -euo pipefail
        wget -qO - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        CODENAME=$(lsb_release -cs)
        sudo bash -c "echo \"deb http://apt.llvm.org/${CODENAME}/ llvm-toolchain-${CODENAME}-21 main\" > /etc/apt/sources.list.d/llvm-21.list"
        sudo apt-get update
        sudo apt-get install -y clang-21 lld-21 ninja-build cmake \
          libxkbcommon-dev qt6-base-dev qt6-base-dev-tools qt6-tools-dev qt6-svg-dev
        echo "clang version: $(clang-21 --version | head -n1)"

    - name: Configure
      run: ./tools/configure.sh ${{ matrix.build-type }}

    - name: Build
      run: ./tools/build.sh ${{ matrix.build-type }}

    - name: Install Xvfb and GL libs
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb mesa-utils mesa-utils-extra libegl-mesa0 libgl1-mesa-dri libgbm1

    - name: Run tests
      run: |
        xvfb-run -a -s "-screen 0 1920x1080x24" ctest --test-dir build/${{ matrix.build-type }} --output-on-failure
